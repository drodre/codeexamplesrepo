{% extends "base.html" %}

{% block title %}{{ title }} - Gestor de Medicamentos{% endblock %}

{% block content %}
<h2>{{ title }}</h2>

<div class="detail-section">
    <h3>Información del Pedido</h3>
    <table class="detail-table">
        <tr><th>ID Pedido:</th><td>{{ pedido.id }}</td></tr>
        <tr><th>Fecha Pedido:</th><td>{{ pedido.fecha_pedido.strftime('%d/%m/%Y') }}</td></tr>
        <tr><th>Proveedor:</th><td>{{ pedido.proveedor if pedido.proveedor else 'N/A' }}</td></tr>
        <tr><th>Estado:</th><td>{{ pedido.estado.value }}</td></tr>
        <tr><th>Costo Total Estimado:</th><td>{{ "%.2f €"|format(costo_total) if costo_total is not none else 'N/A' }}</td></tr>
    </table>
</div>


<div class="detail-section mt-3">
    <h3>Ítems del Pedido</h3>
    {% if pedido.estado.name == 'PENDIENTE' %}
    <div class="mb-2">
        <a href="{{ url_for('crear_detalle_pedido_form', pedido_id=pedido.id) }}" class="btn btn-success btn-sm">
           Añadir Ítem al Pedido
        </a>
    </div>
    {% else %}
    <div class="alert alert-info">
        No se pueden añadir o modificar ítems porque el pedido no está en estado 'Pendiente'. Estado actual: {{ pedido.estado.value }}
    </div>
    {% endif %}

    {% if detalles_pedido %}
        <table>
            <thead>
                <tr>
                    <th scope="col">Medicamento</th>
                    <th scope="col">Marca</th>
                    <th scope="col">Uds./Caja</th>
                    <th scope="col">Cajas Pedidas</th>
                    <th scope="col">Precio Compra/Caja</th>
                    <th scope="col">Subtotal Ítem</th>
                    {% if pedido.estado.name == 'PENDIENTE' %}<th scope="col">Acciones</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for detalle in detalles_pedido %}
                <tr>
                    <td data-label="Medicamento">{{ detalle.medicamento.nombre }}</td>
                    <td data-label="Marca">{{ detalle.medicamento.marca if detalle.medicamento.marca else 'N/A' }}</td>
                    <td data-label="Uds./Caja" class="text-center">{{ detalle.medicamento.unidades_por_caja }}</td>
                    <td data-label="Cajas Pedidas" class="text-center">{{ detalle.cantidad_cajas_pedidas }}</td>
                    <td data-label="Precio Compra/Caja" class="text-right">{{ "%.2f €"|format(detalle.precio_unitario_compra_caja) if detalle.precio_unitario_compra_caja is not none else 'N/A' }}</td>
                    <td data-label="Subtotal Ítem" class="text-right">
                        {# Calculamos el subtotal aquí si es posible, o usamos el que viene de la BD si existe #}
                        {% if detalle.subtotal_detalle is not none %}
                             {{ "%.2f €"|format(detalle.subtotal_detalle) }}
                        {% elif detalle.precio_unitario_compra_caja is not none %}
                            {{ "%.2f €"|format(detalle.cantidad_cajas_pedidas * detalle.precio_unitario_compra_caja) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    {% if pedido.estado.name == 'PENDIENTE' %}
                    <td data-label="Acciones">
                        {# Editar ítem no está implementado en este ciclo, se podría añadir un botón deshabilitado o enlace #}
                        {# <a href="#" class="btn btn-sm btn-warning disabled" title="Editar ítem no implementado">Editar</a> #}
                        <form method="POST" action="{{ url_for('eliminar_detalle_pedido_submit', pedido_id=pedido.id, detalle_id=detalle.id) }}" style="display:inline;">
                            <button type="submit" onclick="return confirm('¿Está seguro de que desea eliminar este ítem del pedido?');"
                                    class="btn btn-sm btn-danger">
                                Eliminar Ítem
                            </button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="alert alert-info">Este pedido aún no tiene ítems.</div>
    {% endif %}
</div>

<div class="mt-3">
    <a href="{{ url_for('editar_pedido_form', pedido_id=pedido.id) }}" class="btn btn-warning">Editar Encabezado del Pedido</a>
    <a href="{{ url_for('eliminar_pedido_confirm_form', pedido_id=pedido.id) }}" class="btn btn-danger">Eliminar Pedido Completo</a>
    <a href="{{ url_for('listar_todos_pedidos') }}" class="btn btn-secondary">Volver a la lista</a>
</div>

{% endblock %}
