{% extends "base.html" %}

{% block title %}{{ form_title }} - Gestor de Medicamentos{% endblock %}

{% block content %}
<h2>{{ form_title }}</h2>

{% if errors %}
    <div class="alert alert-danger">
        <strong>Error(es) en el formulario:</strong>
        <ul>
            {% for error in errors %}
                 <li>
                    {% if error.loc and error.loc|length > 1 %}
                        En campo '{{ error.loc[1] }}': {{ error.msg }}
                    {% elif error.loc and error.loc|length == 1 %}
                         En campo '{{ error.loc[0] }}': {{ error.msg }}
                    {% elif error.msg %}
                        {{ error.msg }}
                    {% else %}
                        Error desconocido.
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<form method="POST" action="{{ form_action }}">
    {% set req_form = request.form if request and request.form else {} %}

    {# Priorizar datos de 'pedido' (que puede ser el objeto de BD o el diccionario de repopulación con errores) #}
    {# Para fechas: si 'pedido' tiene el string (ej. pedido.fecha_pedido_str_form), usarlo. Sino, el objeto fecha. Sino, el form. Sino, el default. #}
    {% set val_fecha_pedido = '' %}
    {% if pedido and pedido.get('fecha_pedido_str_form') %} {# Errores de validación, 'pedido' es el dict de repopulación #}
        {% set val_fecha_pedido = pedido.fecha_pedido_str_form %}
    {% elif pedido and pedido.fecha_pedido and hasattr(pedido.fecha_pedido, 'isoformat') %} {# Edición, 'pedido' es el objeto SQLAlchemy #}
        {% set val_fecha_pedido = pedido.fecha_pedido.isoformat() %}
    {% else %} {# Creación o request.form si disponible #}
        {% set val_fecha_pedido = req_form.get('fecha_pedido', today_date_iso) %}
    {% endif %}

    {% set val_proveedor = '' %}
    {% if pedido and pedido.get('proveedor') is not none %} {# Errores de validación #}
         {% set val_proveedor = pedido.get('proveedor') %}
    {% elif pedido and pedido.proveedor is not none %} {# Edición #}
         {% set val_proveedor = pedido.proveedor %}
    {% else %} {# Creación o request.form #}
         {% set val_proveedor = req_form.get('proveedor', '') %}
    {% endif %}

    {% set val_estado = '' %}
    {% if pedido and pedido.get('estado_str_form') %} {# Errores de validación #}
        {% set val_estado = pedido.get('estado_str_form') %}
    {% elif pedido and pedido.estado and hasattr(pedido.estado, 'name') %} {# Edición #}
        {% set val_estado = pedido.estado.name %}
    {% else %} {# Creación o request.form #}
        {% set val_estado = req_form.get('estado', 'PENDIENTE') %}
    {% endif %}


    <div class="form-group mb-3">
        <label for="fecha_pedido">Fecha del Pedido (YYYY-MM-DD):</label>
        <input type="date" id="fecha_pedido" name="fecha_pedido" class="form-control"
               value="{{ val_fecha_pedido }}" required>
    </div>
    <div class="form-group mb-3">
        <label for="proveedor">Proveedor (Opcional):</label>
        <input type="text" id="proveedor" name="proveedor" class="form-control"
               value="{{ val_proveedor }}">
    </div>
    <div class="form-group mb-3">
        <label for="estado">Estado del Pedido:</label>
        <select id="estado" name="estado" class="form-control">
            {% for estado_enum in estados_posibles %}
                <option value="{{ estado_enum.name }}"
                        {{ 'selected' if val_estado == estado_enum.name else '' }}>
                    {{ estado_enum.value }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Guardar Pedido</button>
        <a href="{{ url_for('listar_todos_pedidos') if not (pedido and pedido.id) else url_for('detalle_pedido_ruta', pedido_id=pedido.id) }}"
           class="btn btn-secondary">
           Cancelar
        </a>
    </div>
</form>

{% endblock %}
