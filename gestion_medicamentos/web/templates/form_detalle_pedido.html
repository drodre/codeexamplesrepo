{% extends "base.html" %}

{% block title %}{{ form_title }} - Gestor de Medicamentos{% endblock %}

{% block content %}
<h2>{{ form_title }}</h2>
<p>Pedido ID: <strong>{{ pedido_id }}</strong></p>

{% if errors %}
    <div class="alert alert-danger">
        <strong>Error(es) en el formulario:</strong>
        <ul>
            {% for error in errors %}
                 <li>
                    {% if error.loc and error.loc|length > 1 %}
                        En campo '{{ error.loc[1] }}': {{ error.msg }}
                    {% elif error.loc and error.loc|length == 1 %}
                         En campo '{{ error.loc[0] }}': {{ error.msg }}
                    {% elif error.msg %}
                        {{ error.msg }}
                    {% else %}
                        Error desconocido.
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<form method="POST" action="{{ form_action }}">
    {% set req_form = request.form if request and request.form else {} %}

    {# 'detalle_data' se pasa desde la ruta Python cuando hay errores de validación, para repopular el formulario #}
    {% set val_medicamento_id = detalle_data.medicamento_id if detalle_data and detalle_data.medicamento_id is not none else req_form.get('medicamento_id', '') %}
    {% set val_cantidad_cajas = detalle_data.cantidad_cajas_pedidas if detalle_data and detalle_data.cantidad_cajas_pedidas is not none else req_form.get('cantidad_cajas_pedidas', '1') %}
    {% set val_precio_caja = detalle_data.precio_unitario_compra_caja if detalle_data and detalle_data.precio_unitario_compra_caja is not none else req_form.get('precio_unitario_compra_caja', '') %}

    <div class="form-group mb-3">
        <label for="medicamento_id">Medicamento:</label>
        <select id="medicamento_id" name="medicamento_id" class="form-control" required>
            <option value="">Seleccione un medicamento...</option>
            {% for med in medicamentos_disponibles %}
                <option value="{{ med.id }}"
                        {{ 'selected' if (val_medicamento_id | string == med.id | string) else '' }}>
                    {{ med.nombre }} ({{ med.marca if med.marca else 'Sin marca' }}) - {{ med.unidades_por_caja }} uds/caja
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group mb-3">
        <label for="cantidad_cajas_pedidas">Cantidad de Cajas Pedidas:</label>
        <input type="number" id="cantidad_cajas_pedidas" name="cantidad_cajas_pedidas" class="form-control"
               value="{{ val_cantidad_cajas }}"
               required min="1">
    </div>

    <div class="form-group mb-3">
        <label for="precio_unitario_compra_caja">Precio Unitario de Compra por Caja (Opcional, ej. 10.50):</label>
        <input type="number" id="precio_unitario_compra_caja" name="precio_unitario_compra_caja" class="form-control"
               value="{{ val_precio_caja }}"
               step="0.01" min="0">
        <small class="form-text text-muted">Si se deja vacío y el medicamento tiene un precio de referencia, este <strong>no</strong> se usará automáticamente aquí; debe ingresarlo si es el precio de compra.</small>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Añadir Ítem al Pedido</button>
        <a href="{{ url_for('detalle_pedido_ruta', pedido_id=pedido_id) }}" class="btn btn-secondary">Cancelar y Volver al Pedido</a>
    </div>
</form>

{% endblock %}
