{% extends "base.html" %}

{% block title %}{{ form_title }} - Gestor de Medicamentos{% endblock %}

{% block content %}
<h2>{{ form_title }}</h2>
{% if medicamento_info %}
    <p>Medicamento: <strong>{{ medicamento_info.nombre }}</strong> (Unidades por caja por defecto: {{ medicamento_info.unidades_por_caja }})</p>
{% endif %}

{% if errors %}
    <div class="alert alert-danger">
        <strong>Error(es) en el formulario:</strong>
        <ul>
            {% for error in errors %}
                 <li>
                    {% if error.loc and error.loc|length > 1 %}
                        En campo '{{ error.loc[1] }}': {{ error.msg }}
                    {% elif error.loc and error.loc|length == 1 %}
                         En campo '{{ error.loc[0] }}': {{ error.msg }}
                    {% elif error.msg %}
                        {{ error.msg }}
                    {% else %}
                        Error desconocido.
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<form method="POST" action="{{ form_action }}">
    {% set req_form = request.form if request and request.form else {} %}

    {# Determinar los valores a usar para repopular, priorizando datos de 'lote' si existen (especialmente en errores de validaci√≥n) #}
    {% set val_cantidad_cajas = lote.cantidad_cajas if lote and lote.cantidad_cajas is not none else req_form.get('cantidad_cajas', '1') %}
    {% set val_unidades_lote = lote.unidades_por_caja_lote if lote and lote.unidades_por_caja_lote is not none else req_form.get('unidades_por_caja_lote', medicamento_info.unidades_por_caja if medicamento_info else '') %}

    {# Para fechas, si 'lote' tiene el string (ej. lote.fecha_compra_lote_str_form), usarlo. Sino, el objeto fecha. Sino, el form. Sino, el default. #}
    {% set val_fecha_compra = '' %}
    {% if lote and lote.get('fecha_compra_lote_str_form') %}
        {% set val_fecha_compra = lote.fecha_compra_lote_str_form %}
    {% elif lote and lote.fecha_compra_lote and hasattr(lote.fecha_compra_lote, 'isoformat') %}
        {% set val_fecha_compra = lote.fecha_compra_lote.isoformat() %}
    {% else %}
        {% set val_fecha_compra = req_form.get('fecha_compra_lote', today_date_iso if not (lote and lote.id) else '') %}
    {% endif %}

    {% set val_fecha_vencimiento = '' %}
    {% if lote and lote.get('fecha_vencimiento_lote_str_form') %}
        {% set val_fecha_vencimiento = lote.fecha_vencimiento_lote_str_form %}
    {% elif lote and lote.fecha_vencimiento_lote and hasattr(lote.fecha_vencimiento_lote, 'isoformat') %}
        {% set val_fecha_vencimiento = lote.fecha_vencimiento_lote.isoformat() %}
    {% else %}
        {% set val_fecha_vencimiento = req_form.get('fecha_vencimiento_lote', '') %}
    {% endif %}

    {% set val_precio_lote = lote.precio_compra_lote_por_caja if lote and lote.precio_compra_lote_por_caja is not none else req_form.get('precio_compra_lote_por_caja', '') %}

    <div class="form-group mb-3">
        <label for="cantidad_cajas">Cantidad de Cajas:</label>
        <input type="number" id="cantidad_cajas" name="cantidad_cajas" class="form-control" required min="1"
               value="{{ val_cantidad_cajas }}">
    </div>
    <div class="form-group mb-3">
        <label for="unidades_por_caja_lote">Unidades por Caja (para este lote):</label>
        <input type="number" id="unidades_por_caja_lote" name="unidades_por_caja_lote" class="form-control" required min="1"
               value="{{ val_unidades_lote }}">
    </div>
    <div class="form-group mb-3">
        <label for="fecha_compra_lote">Fecha de Compra ({{ 'Opcional' if not (lote and lote.id) else 'Obligatoria' }}, YYYY-MM-DD):</label>
        <input type="date" id="fecha_compra_lote" name="fecha_compra_lote" class="form-control"
               value="{{ val_fecha_compra }}"
               {{ 'required' if (lote and lote.id) else '' }}>
    </div>
    <div class="form-group mb-3">
        <label for="fecha_vencimiento_lote">Fecha de Vencimiento (YYYY-MM-DD):</label>
        <input type="date" id="fecha_vencimiento_lote" name="fecha_vencimiento_lote" class="form-control" required
               value="{{ val_fecha_vencimiento }}">
    </div>
    <div class="form-group mb-3">
        <label for="precio_compra_lote_por_caja">Precio de Compra por Caja para este Lote (Opcional, ej. 9.75):</label>
        <input type="number" id="precio_compra_lote_por_caja" name="precio_compra_lote_por_caja" class="form-control" step="0.01" min="0"
               value="{{ val_precio_lote }}">
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Guardar Lote</button>
        <a href="{{ url_for('detalle_medicamento', medicamento_id=(medicamento_info.id if medicamento_info else (lote.medicamento_id if lote and lote.medicamento_id else 0))) }}" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

{% endblock %}
